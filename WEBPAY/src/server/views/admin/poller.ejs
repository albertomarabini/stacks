<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin • Poller</title>
  <link rel="stylesheet" href="/static/css/admin.css">
  <% if (brandCssStyle) { %><%- brandCssStyle %><% } %>
  <style>
    .card{background:#fff;border-radius:1rem;box-shadow:0 1px 4px rgba(0,0,0,.08)}
    .pill{display:inline-block;padding:.20rem .55rem;border-radius:999px;font-size:.85rem}
    .pill.green{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .pill.red{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.75rem}
    .k{color:#6b7280}
    .v{font-weight:600}
    .actions{display:flex;gap:.5rem;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem .9rem;border-radius:.6rem;
         background:var(--brand,#111827);color:#fff;text-decoration:none;border:none;cursor:pointer}
    .btn.secondary{background:#f3f4f6;color:#111827;border:1px solid #e5e7eb}
    .btn:hover{filter:brightness(1.05)}
    @media (max-width:700px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body class="bg-gray-50">
  <main style="max-width:880px;margin:3rem auto;padding:2rem" class="card">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
      <h1 class="text-2xl font-semibold">Poller</h1>
      <span id="runningPill" class="pill">—</span>
    </header>

    <section class="grid" style="margin-bottom:1rem">
      <div class="card" style="padding:1rem">
        <div class="k">Last run (UTC)</div>
        <div class="v" id="lastRunTxt">—</div>
      </div>
      <div class="card" style="padding:1rem">
        <div class="k">Last chain height</div>
        <div class="v" id="lastHeightTxt">—</div>
      </div>
      <div class="card" style="padding:1rem">
        <div class="k">Last tx id</div>
        <div class="v" id="lastTxTxt" style="word-break:break-all">—</div>
      </div>
      <div class="card" style="padding:1rem">
        <div class="k">Lag (blocks)</div>
        <div class="v" id="lagTxt">—</div>
      </div>
    </section>

    <section class="actions" style="margin-bottom:.5rem">
      <!-- Restart -->
      <form method="post" action="/admin/poller/restart">
        <% if (typeof csrfToken === 'string') { %>
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <% } %>
        <button class="btn" type="submit" title="Ask Bridge to restart the poller">⟳ Restart</button>
      </form>
      <!-- Refresh (GET) -->
      <a class="btn secondary" href="/admin/poller" title="Reload status">↻ Refresh</a>
    </section>

    <!-- Raw payload for debugging -->
    <details style="margin-top:1rem">
      <summary class="k">Raw status payload</summary>
      <pre class="bg-gray-100 p-3 rounded"><%= JSON.stringify(pollerStatus || {}, null, 2) %></pre>
    </details>
  </main>

  <script>
    (function () {
      const data = <%- JSON.stringify(pollerStatus || {}) %>;

      const pill = document.getElementById('runningPill');
      const lastRunTxt = document.getElementById('lastRunTxt');
      const lastHeightTxt = document.getElementById('lastHeightTxt');
      const lastTxTxt = document.getElementById('lastTxTxt');
      const lagTxt = document.getElementById('lagTxt');

      // running pill
      const running = !!data.running;
      pill.textContent = running ? 'Running' : 'Stopped';
      pill.classList.add('pill', running ? 'green' : 'red');

      // last run (epoch seconds → ISO)
      const s = Number(data.lastRunAt);
      if (Number.isFinite(s) && s > 0) {
        const d = new Date(s * 1000);
        lastRunTxt.textContent = d.toISOString().replace('T',' ').replace('Z',' UTC');
      } else {
        lastRunTxt.textContent = '—';
      }

      // last height
      lastHeightTxt.textContent = (Number.isFinite(data.lastHeight) ? String(data.lastHeight) : '—');

      // last tx id
      lastTxTxt.textContent = (typeof data.lastTxId === 'string' && data.lastTxId.length ? data.lastTxId : '—');

      // lag with color cue
      const lag = Number(data.lagBlocks);
      if (Number.isFinite(lag)) {
        lagTxt.textContent = String(lag);
        lagTxt.style.color = lag > 100 ? '#b91c1c' : lag > 25 ? '#b45309' : '#065f46';
      } else {
        lagTxt.textContent = '—';
      }
    })();
  </script>
</body>
</html>
