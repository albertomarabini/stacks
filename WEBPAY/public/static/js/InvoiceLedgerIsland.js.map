{
  "version": 3,
  "sources": ["../../../src/client/islands/InvoiceLedgerIsland.ts"],
  "sourcesContent": ["/* eslint-disable no-alert, no-console */\n\n// ---- Page data\ntype PageData = {\n    kind: 'invoices';\n    storeId: string;\n    filterUrl: string;          // /merchant/:storeId/invoices/filter\n    actionsBase: string;        // /merchant/:storeId/invoices\n    csrfToken?: string | null;\n  };\n  const data: PageData = (window as any).__PAGE__ || {\n    kind: 'invoices',\n    storeId: '',\n    filterUrl: '',\n    actionsBase: '',\n    csrfToken: null,\n  };\n\n  // meta fallback (if template already injected one in <head> via layout)\n  function readMetaCsrf(): string | null {\n    const m = document.querySelector('meta[name=\"csrf-token\"]') as HTMLMetaElement | null;\n    return m?.content || null;\n  }\n\n  function $(sel: string, root: Document | HTMLElement = document) {\n    return Array.from(root.querySelectorAll(sel)) as HTMLElement[];\n  }\n\n  // small HTML escaper for safety\n  function esc(s: any) { return String(s ?? '').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[c]!)); }\n\n  async function getJson(url: string) {\n    const res = await fetch(url, { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' });\n    if (!res.ok) throw new Error(`HTTP ${res.status}`);\n    return res.json();\n  }\n\n  function renderInvoiceDialog(model: any) {\n    const body = document.getElementById('invoice-dialog-body');\n    if (!body) return;\n    body.innerHTML = `\n      <dl class=\"grid grid-cols-2 gap-x-4 gap-y-2\">\n        <dt class=\"text-muted\">Invoice</dt><dd class=\"font-mono\">${esc(model.id || model.invoiceId || model.idRaw)}</dd>\n        <dt class=\"text-muted\">Status</dt><dd><span class=\"badge\">${esc(model.status)}</span></dd>\n        <dt class=\"text-muted\">Amount</dt><dd>${esc(model.amountSats)} sats</dd>\n        <dt class=\"text-muted\">Memo</dt><dd>${esc(model.memo || '')}</dd>\n        <dt class=\"text-muted\">Created</dt><dd>${esc(model.createdAt || '')}</dd>\n        <dt class=\"text-muted\">Payer</dt><dd>${esc(model.payer || model.payerPrincipal || '')}</dd>\n      </dl>\n    `;\n  }\n\n  async function openInvoice(invoiceId: string) {\n    const dlg = document.getElementById('invoice-dialog') as HTMLDialogElement | null;\n    try {\n      dlg?.showModal();\n      const json = await getJson(`/status/${encodeURIComponent(data.storeId)}/${encodeURIComponent(invoiceId)}`);\n      renderInvoiceDialog(json);\n    } catch (err) {\n      console.warn('load invoice failed', err);\n      alert('Could not load invoice details.');\n      dlg?.close();\n    }\n  }\n  // ---- Helpers\n  function toUrlEncoded(body: Record<string, any>) {\n    const qs = new URLSearchParams();\n    for (const [k, v] of Object.entries(body)) qs.append(k, String(v ?? ''));\n    return qs;\n  }\n\n  async function postHtml(url: string, body: Record<string, any>) {\n    const token = data.csrfToken || readMetaCsrf();\n    const qs = toUrlEncoded(body);\n    if (token && !qs.get('_csrf')) qs.append('_csrf', token);\n\n    const res = await fetch(url, {\n      method: 'POST',\n      headers: {\n        'Accept': 'text/html',\n        'X-Requested-With': 'XMLHttpRequest',\n        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',\n      },\n      body: qs.toString(),\n      credentials: 'same-origin',\n    });\n    if (!res.ok) throw new Error(`HTTP ${res.status}`);\n    return res.text();\n  }\n\n  async function postAction(url: string, body: Record<string, any> = {}) {\n    const token = data.csrfToken || readMetaCsrf();\n    const qs = toUrlEncoded(body);\n    if (token && !qs.get('_csrf')) qs.append('_csrf', token);\n\n    const res = await fetch(url, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },\n      body: qs.toString(),\n      credentials: 'same-origin',\n    });\n    if (!res.ok) throw new Error(`HTTP ${res.status}`);\n  }\n\n  // ---- Filter (status only) + render results\n  function attachFilter() {\n    const form = document.getElementById('invoice-filter-form') as HTMLFormElement | null;\n    const target = document.getElementById('ledger-results');\n    if (!form || !target) return;\n\n    form.addEventListener('submit', async (e) => {\n          e.preventDefault();\n          try { await refreshLedgerFromForm(); }\n          catch (err) { console.warn('filter failed', err); }\n        });\n  }\n\n  async function refreshLedgerFromForm() {\n      const form = document.getElementById('invoice-filter-form') as HTMLFormElement | null;\n      const target = document.getElementById('ledger-results');\n      if (!form || !target) return;\n      const fd = new FormData(form);\n      const status = String(fd.get('status') || '');\n      target.classList.add('opacity-60','pointer-events-none');\n      try {\n        const html = await postHtml(data.filterUrl, { status });\n        const doc = new DOMParser().parseFromString(html, 'text/html');\n        const fresh = doc.getElementById('ledger-results');\n        target.innerHTML = fresh ? fresh.innerHTML : html;\n        bindRowActions();\n      } finally {\n        target.classList.remove('opacity-60','pointer-events-none');\n      }\n    }\n\n  // ---- Row actions (view / cancel / refund)\n  function bindRowActions() {\n    // Invoice rows\n    $('[data-row-kind=\"invoice\"]').forEach((row) => {\n      const invoiceId = row.getAttribute('data-invoice-id')!;\n      // view\n      row.querySelector<HTMLElement>('[data-action=\"view-invoice\"]')?.addEventListener('click', () => {\n        openInvoice(invoiceId);\n      });\n      // cancel\n      row.querySelector<HTMLElement>('[data-action=\"cancel-invoice\"]')?.addEventListener('click', async () => {\n        if (!confirm('Cancel this invoice?')) return;\n        await postAction(`${data.actionsBase}/${encodeURIComponent(invoiceId)}/cancel`);\n        // refresh current filter silently\n        await refreshLedgerFromForm();\n      });\n      // refund\n      row.querySelector<HTMLElement>('[data-action=\"refund-invoice\"]')?.addEventListener('click', async () => {\n        const amt = prompt('Refund amount (sats):', '0');\n        if (!amt) return;\n        const memo = prompt('Refund memo (optional):', '') || '';\n        await postAction(`${data.actionsBase}/${encodeURIComponent(invoiceId)}/refund`, { amount: amt, memo });\n        await refreshLedgerFromForm();\n      });\n    });\n  }\n\n  // ---- boot\n  attachFilter();\n  bindRowActions();\n  document.querySelector('#invoice-dialog [data-close]')?.addEventListener('click', () => {\n      (document.getElementById('invoice-dialog') as HTMLDialogElement)?.close();\n    });\n"],
  "mappings": "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",
  "names": []
}
