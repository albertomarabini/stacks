{"version":3,"file":"HttpApiServer.js","sourceRoot":"","sources":["../../src/server/HttpApiServer.ts"],"names":[],"mappings":"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","sourcesContent":["// src/server/HttpApiServer.ts\nimport express, { Express, RequestHandler } from 'express';\nimport { PublicApiController } from '../controllers/PublicApiController';\nimport { MerchantApiController } from '../controllers/MerchantApiController';\nimport { AdminApiController } from '../controllers/AdminApiController';\nimport { HealthController } from '../controllers/HealthController';\nimport { AdminAuth } from '../middleware/AdminAuth';\nimport { StoreApiAuth } from '../middleware/StoreApiAuth';\nimport { CrossTenantMask } from '../middleware/CrossTenantMask';\nimport { RateLimitPolicy } from '../middleware/RateLimitPolicy';\nimport { CorsPolicy } from '../middleware/CorsPolicy';\nimport { AdminStaticServer } from '../servers/AdminStaticServer';\nimport { PaymentPoller } from '../poller/PaymentPoller';\nimport { WebhookRetryScheduler } from '../webhooks/WebhookRetryScheduler';\nimport { SubscriptionScheduler } from '../schedulers/SubscriptionScheduler';\nimport { AdminSurfaceBinder } from '../delegates/AdminSurfaceBinder';\nimport { WebhookInboundSurfaceBinder } from '../delegates/WebhookInboundSurfaceBinder';\nimport { RootRouteBinder } from '../delegates/RootRouteBinder';\nimport { SchedulerStartupCoordinator } from '../delegates/SchedulerStartupCoordinator';\nimport { CorsMiddlewareFactory } from '../delegates/CorsMiddlewareFactory';\nimport type { IConfigService } from '../contracts/interfaces';\n\ntype AdminGuard = { authenticateAdmin(req: any, res: any, next: any): void };\nconst JSON_LIMIT = process.env.HTTP_JSON_LIMIT || '256kb';\n\nexport class HttpApiServer {\n  private readonly adminBinder = new AdminSurfaceBinder();\n  private readonly inboundBinder = new WebhookInboundSurfaceBinder();\n  private readonly rootBinder = new RootRouteBinder();\n  private readonly schedulerCoordinator = new SchedulerStartupCoordinator();\n  private readonly corsFactory = new CorsMiddlewareFactory();\n\n  mountAdminAuth(app: Express, adminAuth: AdminGuard): void {\n    this.adminBinder.bindAdminAuth(app, adminAuth);\n  }\n\n  mountAdminStatic(\n    app: Express,\n    adminAuth: AdminGuard,\n    staticMiddleware: RequestHandler,\n  ): void {\n    this.adminBinder.bindAdminStatic(app, adminAuth, staticMiddleware);\n  }\n\n  mountRoot(app: Express, handler: { getRoot(req: any, res: any): void }): void {\n    this.rootBinder.bindRoot(app, handler);\n  }\n\n  mountAdminIndex(\n    app: Express,\n    adminAuth: AdminGuard,\n    serveIndex: (req: any, res: any) => void,\n  ): void {\n    this.adminBinder.bindAdminIndex(app, adminAuth, serveIndex);\n  }\n\n  mountInboundWebhookVerifier(app: Express, verifierMw: RequestHandler): void {\n    this.inboundBinder.bind(app, verifierMw);\n  }\n\n  composeRoutesAndMiddleware(app: Express, deps: {\n    publicCtrl: PublicApiController;\n    merchantCtrl: MerchantApiController;\n    adminCtrl: AdminApiController;\n    healthCtrl: HealthController;\n    adminAuth: AdminAuth;\n    storeAuth: StoreApiAuth;\n    crossTenantMask: CrossTenantMask;\n    rateLimit: RateLimitPolicy;\n    corsPolicy: CorsPolicy;\n    staticServer: AdminStaticServer; // <-- ensure this exists in the type\n    webhookVerifier: RequestHandler;\n  }): void {\n    deps.rateLimit.initLimiters();\n\n    this.mountAdminAuth(app, deps.adminAuth);\n    this.mountInboundWebhookVerifier(app, deps.webhookVerifier);\n\n    const corsGetInvoice = this.corsFactory.create(['GET', 'OPTIONS'], deps.corsPolicy as any);\n    const corsCreateTx = this.corsFactory.create(['POST', 'OPTIONS'], deps.corsPolicy as any);\n    const corsPublicProfile = this.corsFactory.create(['GET', 'OPTIONS'], deps.corsPolicy as any);\n\n    // Public routes + preflights\n\n    app.options('/i/:invoiceId', corsGetInvoice);\n    app.get(\n      '/i/:invoiceId',\n      deps.rateLimit.publicInvoiceViewLimiter,\n      corsGetInvoice,\n      (req, res) => deps.publicCtrl.getInvoice(req, res),\n    );\n\n    app.options('/create-tx', corsCreateTx);\n    app.post(\n      '/create-tx',\n      deps.rateLimit.publicCreateTxLimiter,\n      corsCreateTx,\n      express.json({ limit: JSON_LIMIT }),\n      (req, res) => deps.publicCtrl.createTx(req, res),\n    );\n\n    app.get(\n      '/api/v1/stores/:storeId/public-profile',\n      deps.rateLimit.publicProfileLimiter,\n      corsPublicProfile,\n      // Guarantee ACAO on GET (fallback if CORS layer didn’t set it)\n      (req, res, next) => {\n        if (!res.getHeader('Access-Control-Allow-Origin')) {\n          res.setHeader('Access-Control-Allow-Origin', '*');\n        }\n        next();\n      },\n      (req, res) => deps.publicCtrl.getStorePublicProfile(req, res),\n    );\n\n    app.options('/api/v1/stores/:storeId/public-profile', corsPublicProfile);\n\n    // Merchant-scoped routes\n    const auth = (req: any, res: any, next: any) => deps.storeAuth.verifyApiKey(req, res, next);\n    const mask = (req: any, res: any, next: any) => deps.crossTenantMask.enforce(req, res, next);\n\n    // NEW: one-shot “prepare invoice” that returns invoice + unsigned tx + deeplink\n    app.post(\n      '/api/v1/stores/:storeId/prepare-invoice',\n      auth,                  // ← merchant API key\n      mask,                  // ← cross-tenant guard\n      deps.rateLimit.createInvoiceLimiter,\n      express.json({ limit: JSON_LIMIT }),\n      (req, res) => deps.merchantCtrl.prepareInvoice(req, res),  // ← new action\n    );\n\n\n    app.post(\n      '/api/v1/stores/:storeId/invoices',\n      auth,\n      mask,\n      deps.rateLimit.createInvoiceLimiter,\n      express.json({ limit: JSON_LIMIT }),\n      (req, res) => deps.merchantCtrl.createInvoice(req, res),\n    );\n\n    app.get(\n      '/api/v1/stores/:storeId/invoices',\n      auth,\n      mask,\n      (req, res) => deps.merchantCtrl.listInvoices(req, res),\n    );\n\n    app.get(\n      '/api/v1/stores/:storeId/invoices/:invoiceId',\n      auth,\n      mask,\n      (req, res) => deps.merchantCtrl.getInvoice(req, res),\n    );\n\n    app.post(\n      '/api/v1/stores/:storeId/invoices/:invoiceId/cancel',\n      auth,\n      mask,\n      (req, res) => deps.merchantCtrl.cancelInvoice(req, res),\n    );\n\n    // Builder first (test tries this one initially)\n    app.post(\n      '/api/v1/stores/:storeId/invoices/:invoiceId/cancel/create-tx',\n      auth, mask,\n      (req, res) => deps.merchantCtrl.cancelInvoiceCreateTx(req, res),\n    );\n\n    app.post(\n      '/api/v1/stores/:storeId/refunds',\n      auth,\n      mask,\n      express.json({ limit: JSON_LIMIT }),\n      (req, res) => deps.merchantCtrl.buildRefund(req, res),\n    );\n\n    app.post(\n      '/api/v1/stores/:storeId/refunds/create-tx',\n      auth, mask,\n      deps.rateLimit.createInvoiceLimiter,\n      express.json({ limit: JSON_LIMIT }),\n      (req, res) => deps.merchantCtrl.buildRefundTx(req, res),\n    );\n\n    app.get(\n      '/api/v1/stores/:storeId/webhooks',\n      auth,\n      mask,\n      (req, res) => deps.merchantCtrl.listWebhooks(req, res),\n    );\n\n    // POC: make store profile publicly readable\n    app.get(\n      '/api/v1/stores/:storeId/profile',\n      auth,\n      mask,\n      (req, res) => deps.merchantCtrl.getStoreProfile(req, res),\n    );\n\n    app.patch(\n      '/api/v1/stores/:storeId/profile',\n      auth,\n      mask,\n      express.json({ limit: JSON_LIMIT }),\n      (req, res) => deps.merchantCtrl.updateStoreProfile(req, res),\n    );\n\n    app.post(\n      '/api/v1/stores/:storeId/update-stx-key',\n      auth,\n      mask,\n      (req, res) => deps.merchantCtrl.updateStxPrivateKey(req, res),\n    );\n\n    app.get(\n      '/api/v1/stores/:storeId/subscriptions',\n      auth,\n      mask,\n      express.json({ limit: JSON_LIMIT }),\n      (req, res) => deps.merchantCtrl.createSubscription(req, res),\n    );\n\n    app.post(\n      '/api/v1/stores/:storeId/subscriptions',\n      auth,\n      mask,\n      express.json({ limit: JSON_LIMIT }),\n      (req, res) => deps.merchantCtrl.createSubscription(req, res),\n    );\n\n    app.post(\n      '/api/v1/stores/:storeId/subscriptions/:id/invoice',\n      auth,\n      mask,\n      deps.rateLimit.subInvoiceLimiter,\n      express.json({ limit: JSON_LIMIT }),\n      (req, res) => deps.merchantCtrl.genSubscriptionInvoice(req, res),\n    );\n\n    app.post(\n      '/api/v1/stores/:storeId/subscriptions/:id/mode',\n      auth,\n      mask,\n      express.json({ limit: JSON_LIMIT }),\n      (req, res) => deps.merchantCtrl.setSubscriptionMode(req, res),\n    );\n\n    app.post(\n      '/api/v1/stores/:storeId/subscriptions/:id/cancel',\n      auth,\n      mask,\n      express.json({ limit: JSON_LIMIT }),\n      (req, res) => deps.merchantCtrl.cancelSubscription(req, res),\n    );\n\n    app.post(\n      '/api/v1/stores/:storeId/subscriptions/:id/create-tx',\n      auth,\n      mask,\n      express.json({ limit: JSON_LIMIT }),\n      (req, res) => deps.merchantCtrl.buildDirectSubscriptionPaymentTx(req, res),\n    );\n\n    // Admin API\n    const adminGuard = (req: any, res: any, next: any) =>\n      deps.adminAuth.authenticateAdmin(req, res, next);\n\n    //-------------------------------------------------------------------------\n    // This is a patch created just for the POC. It should be engineered differently\n    //\n    //-------------------------------------------------------------------------\n    app.get(\n      '/api/admin/stores/:storeId/secret',\n      adminGuard,\n      (req, res) => deps.adminCtrl.getStoreSecret(req, res),\n    );\n\n    app.post('/api/admin/bootstrap', adminGuard, (req, res) =>\n      deps.adminCtrl.bootstrapAdmin(req, res)\n    );\n    app.get('/api/admin/invoices', adminGuard, (req, res) => deps.adminCtrl.listInvoices(req, res));\n\n\n    // LIST stores (missing → adds support for test 55)\n    app.get(\n      '/api/admin/stores',\n      adminGuard,\n      (req, res) => deps.adminCtrl.listStores(req, res),\n    );\n\n    // CREATE store (keep a single registration)\n    app.post(\n      '/api/admin/stores',\n      express.json({ limit: JSON_LIMIT }),\n      adminGuard,\n      (req, res) => deps.adminCtrl.createStore(req, res),\n    );\n\n    app.patch(\n      '/api/admin/stores/:storeId/activate',\n      adminGuard,\n      express.json({ limit: JSON_LIMIT }),\n      (req, res) => deps.adminCtrl.activateStore(req, res),\n    );\n\n    app.post(\n      '/api/admin/stores/:storeId/rotate-keys',\n      adminGuard,\n      (req, res) => deps.adminCtrl.rotateKeys(req, res),\n    );\n\n    app.post(\n      '/api/admin/stores/:storeId/sync-onchain',\n      adminGuard,\n      (req, res) => deps.adminCtrl.syncOnchain(req, res),\n    );\n\n    app.post(\n      '/api/admin/set-sbtc-token',\n      adminGuard,\n      express.json({ limit: JSON_LIMIT }),\n      (req, res) => deps.adminCtrl.setSbtcToken(req, res),\n    );\n\n    app.get('/api/admin/poller', adminGuard, (req, res) => deps.adminCtrl.getPoller(req, res));\n\n    app.post(\n      '/api/admin/poller/restart',\n      adminGuard,\n      (req, res) => deps.adminCtrl.restartPoller(req, res),\n    );\n\n    app.get(\n      '/api/admin/webhooks',\n      adminGuard,\n      (req, res) => deps.adminCtrl.listWebhooks(req, res),\n    );\n\n    app.post(\n      '/api/admin/webhooks/retry',\n      adminGuard,\n      express.json({ limit: JSON_LIMIT }),\n      (req, res) => deps.adminCtrl.retryWebhook(req, res),\n    );\n\n    app.post(\n      '/api/admin/invoices/:invoiceId/cancel',\n      adminGuard,\n      (req, res) => deps.adminCtrl.cancelInvoice(req, res),\n    );\n\n    // Admin SPA (static + index) — safe if directory missing (middleware no-ops)\n    this.mountAdminStatic(app, deps.adminAuth, deps.staticServer.serveStatic());\n    this.mountAdminIndex(app, deps.adminAuth, (req, res) => deps.staticServer.serveIndex(req, res));\n\n    // Health/root\n    this.mountRoot(app, deps.healthCtrl);\n  }\n\n  async start(deps: {\n    app: Express;\n    poller: PaymentPoller;\n    webhookRetry: WebhookRetryScheduler;\n    subscriptionScheduler?: SubscriptionScheduler;\n    config: IConfigService;\n  }): Promise<void> {\n    await this.schedulerCoordinator.startSchedulers({\n      poller: deps.poller,\n      webhookRetry: deps.webhookRetry,\n      subscriptionScheduler: deps.subscriptionScheduler,\n      config: deps.config,\n    });\n  }\n}\n"]}