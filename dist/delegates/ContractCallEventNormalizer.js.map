{"version":3,"file":"ContractCallEventNormalizer.js","sourceRoot":"","sources":["../../src/delegates/ContractCallEventNormalizer.ts"],"names":[],"mappings":";;;AAIA,uDAAyD;AAEzD,gFAAgF;AAChF,MAAM,UAAU,GAAG,CAAC,CAAU,EAAE,EAAE,CAAC,MAAM,CAAC,CAAC,IAAI,EAAE,CAAC,CAAC,OAAO,CAAC,MAAM,EAAE,EAAE,CAAC,CAAC,WAAW,EAAE,CAAC;AACrF,MAAM,MAAM,GAAG,CAAC,KAAU,EAAE,EAAE;IAC5B,MAAM,CAAC,GAAG,MAAM,CAAC,KAAK,IAAI,EAAE,CAAC,CAAC;IAC9B,OAAO,MAAM,CAAC,CAAC,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;AACpD,CAAC,CAAC;AACF,MAAM,aAAa,GAAG,CAAC,EAAO,EAAE,EAAE;IAChC,MAAM,CAAC,GAAG,EAAE,EAAE,UAAU,IAAI,EAAE,EAAE,SAAS,CAAC;IAC1C,OAAO,CAAC,KAAK,oBAAoB,IAAI,CAAC,KAAK,cAAc,CAAC;AAC5D,CAAC,CAAC;AACF,MAAM,KAAK,GAAG,CAAC,CAAS,EAAE,CAAC,GAAG,GAAG,EAAE,EAAE,CAAC,CAAC,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;AAE7E,qFAAqF;AACrF,SAAS,UAAU,CAAC,EAAO;IACzB,MAAM,CAAC,GAAG,EAAE,EAAE,YAAY,EAAE,KAAK,CAAC;IAClC,MAAM,IAAI,GAAW,MAAM,CAAC,CAAC,EAAE,IAAI,IAAI,EAAE,CAAC,CAAC;IAC3C,MAAM,GAAG,GAAuB,CAAC,EAAE,GAAG,CAAC;IAEvC,IAAI,GAAG,EAAE,CAAC;QACR,IAAI,CAAC;YACH,MAAM,EAAE,GAAG,IAAA,sBAAO,EAAC,GAAG,CAAC,CAAC;YACxB,IAAI,CAAC,GAAQ,IAAA,uBAAQ,EAAC,EAAE,CAAC,CAAC;YAC1B,IAAI,CAAC,EAAE,IAAI,KAAK,UAAU,IAAI,CAAC,CAAC,KAAK;gBAAE,CAAC,GAAG,CAAC,CAAC,KAAK,CAAC;YAEnD,+BAA+B;YAC/B,IAAI,KAAK,GAAG,CAAC,CAAC;YACd,IAAI,KAAK,EAAE,IAAI,KAAK,OAAO,IAAI,KAAK,EAAE,KAAK,EAAE,IAAI,KAAK,OAAO;gBAAE,KAAK,GAAG,KAAK,CAAC,KAAK,CAAC;YAEnF,8DAA8D;YAC9D,MAAM,MAAM,GAAU,KAAK,CAAC,OAAO,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,CAAC;YACrE,MAAM,GAAG,GAAG,CAAC,CAAS,EAAE,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,CAAM,EAAE,EAAE,CAAC,CAAC,EAAE,IAAI,KAAK,CAAC,CAAC,EAAE,KAAK,CAAC;YAEzE,YAAY;YACZ,MAAM,MAAM,GAAG,GAAG,CAAC,OAAO,CAAC,IAAI,GAAG,CAAC,KAAK,CAAC,CAAC;YAC1C,MAAM,GAAG,GAAG,MAAM,CAAC,MAAM,EAAE,KAAK,IAAI,MAAM,IAAI,EAAE,CAAC,CAAC,WAAW,EAAE,CAAC;YAEhE,YAAY;YACZ,MAAM,IAAI,GAAG,GAAG,CAAC,IAAI,CAAC,CAAC;YACvB,MAAM,KAAK,GAAG,UAAU,CAAC,MAAM,CAAC,IAAI,EAAE,KAAK,IAAI,IAAI,IAAI,EAAE,CAAC,CAAC,CAAC;YAE5D,gBAAgB;YAChB,MAAM,KAAK,GAAG,GAAG,CAAC,QAAQ,CAAC,CAAC;YAC5B,MAAM,UAAU,GAAG,MAAM,CAAC,KAAK,EAAE,KAAK,IAAI,KAAK,CAAC,CAAC;YAEjD,YAAY;YACZ,MAAM,WAAW,GAAG,GAAG,CAAC,UAAU,CAAC,CAAC;YACpC,MAAM,QAAQ,GAAG,MAAM,CAAC,WAAW,EAAE,KAAK,IAAI,WAAW,IAAI,EAAE,CAAC,IAAI,SAAS,CAAC;YAE9E,MAAM,aAAa,GAAG,GAAG,CAAC,YAAY,CAAC,CAAC;YACxC,MAAM,UAAU,GAAG,MAAM,CAAC,aAAa,EAAE,KAAK,IAAI,aAAa,IAAI,EAAE,CAAC,IAAI,SAAS,CAAC;YAEpF,MAAM,WAAW,GAAG,GAAG,CAAC,iBAAiB,CAAC,IAAI,GAAG,CAAC,UAAU,CAAC,CAAC;YAC9D,MAAM,cAAc,GAAG,MAAM,CAAC,WAAW,EAAE,KAAK,IAAI,WAAW,CAAC,CAAC;YAEjE,IAAI,GAAG,EAAE,CAAC;gBACR,OAAO,EAAE,GAAG,EAAE,KAAK,EAAE,UAAU,EAAE,QAAQ,EAAE,UAAU,EAAE,cAAc,EAAE,IAAI,EAAE,CAAC;YAChF,CAAC;QACH,CAAC;QAAC,MAAM,CAAC;YACP,+BAA+B;QACjC,CAAC;IACH,CAAC;IAED,mDAAmD;IACnD,MAAM,CAAC,GACL,wFAAwF,CAAC,IAAI,CAC3F,IAAI,CACL,CAAC;IACJ,IAAI,CAAC,EAAE,CAAC;QACN,OAAO;YACL,GAAG,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,WAAW,EAAE;YACvB,KAAK,EAAE,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,CAAC;YAC7B,UAAU,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,GAAG,CAAC;YAC/B,IAAI;SACL,CAAC;IACJ,CAAC;IAED,MAAM,EAAE,GAAG,0CAA0C,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IACjE,IAAI,EAAE;QAAE,OAAO,EAAE,GAAG,EAAE,EAAE,CAAC,CAAC,CAAC,CAAC,WAAW,EAAE,EAAE,IAAI,EAAE,CAAC;IAElD,OAAO,IAAI,CAAC;AACd,CAAC;AAED,gFAAgF;AAChF,MAAa,2BAA2B;IACtC,KAAK,CAAC,oBAAoB,CAAC,UAAkB,EAAE,KAAyB,EAAE,KAAmB;QAC3F,MAAM,MAAM,GAAG,MAAM,KAAK,CAAC,qBAAqB,CAAC,EAAE,UAAU,EAAE,CAAC,CAAC;QAEjE,MAAM,GAAG,GAAsB,EAAE,CAAC;QAElC,KAAK,MAAM,EAAE,IAAI,MAAM,EAAE,CAAC;YACxB,6BAA6B;YAC7B,IAAI,CAAC,aAAa,CAAC,EAAE,CAAC,EAAE,CAAC;gBACvB,OAAO,CAAC,KAAK,CAAC,kCAAkC,EAAE;oBAChD,KAAK,EAAE,EAAE,EAAE,KAAK,IAAI,EAAE,EAAE,IAAI;oBAC5B,UAAU,EAAE,EAAE,EAAE,UAAU,IAAI,EAAE,EAAE,SAAS;iBAC5C,CAAC,CAAC;gBACH,SAAS;YACX,CAAC;YAED,uCAAuC;YACvC,MAAM,YAAY,GAAG,MAAM,CAAC,EAAE,EAAE,YAAY,IAAI,EAAE,EAAE,EAAE,EAAE,YAAY,IAAI,GAAG,CAAC,CAAC;YAC7E,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,YAAY,CAAC,EAAE,CAAC;gBACnC,OAAO,CAAC,KAAK,CAAC,iCAAiC,EAAE;oBAC/C,KAAK,EAAE,EAAE,EAAE,KAAK,IAAI,EAAE,EAAE,IAAI;iBAC7B,CAAC,CAAC;gBACH,SAAS;YACX,CAAC;YAED,MAAM,KAAK,GAAW,MAAM,CAAC,EAAE,EAAE,KAAK,IAAI,EAAE,EAAE,IAAI,IAAI,EAAE,CAAC,CAAC;YAC1D,MAAM,QAAQ,GAAW,MAAM,CAAC,EAAE,EAAE,QAAQ,IAAI,CAAC,CAAC,CAAC;YAEnD,4BAA4B;YAC5B,MAAM,CAAC,GAAG,UAAU,CAAC,EAAE,CAAC,CAAC;YACzB,IAAI,CAAC,CAAC,EAAE,CAAC;gBACP,MAAM,IAAI,GAAG,MAAM,CAAC,EAAE,EAAE,YAAY,EAAE,KAAK,EAAE,IAAI,IAAI,EAAE,CAAC,CAAC;gBACzD,OAAO,CAAC,KAAK,CAAC,4BAA4B,EAAE;oBAC1C,KAAK,EAAE,YAAY,EAAE,QAAQ,EAAE,IAAI,EAAE,KAAK,CAAC,IAAI,CAAC;iBACjD,CAAC,CAAC;gBACH,SAAS;YACX,CAAC;YAED,OAAO,CAAC,KAAK,CAAC,mBAAmB,EAAE;gBACjC,GAAG,EAAE,CAAC,CAAC,GAAG,EAAE,KAAK,EAAE,CAAC,CAAC,KAAK,EAAE,UAAU,EAAE,CAAC,CAAC,UAAU,EAAE,KAAK,EAAE,YAAY,EAAE,QAAQ;gBACnF,IAAI,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,SAAS;aACzC,CAAC,CAAC;YAEH,wBAAwB;YACxB,MAAM,GAAG,GAAG,CAAC,CAAC,GAAG,CAAC;YAClB,MAAM,KAAK,GAAG,UAAU,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC;YAElC,MAAM,kBAAkB,GAAG,GAAG,EAAE;gBAC9B,IAAI,CAAC,KAAK,EAAE,CAAC;oBACX,OAAO,CAAC,KAAK,CAAC,0BAA0B,EAAE,EAAE,KAAK,EAAE,GAAG,EAAE,CAAC,CAAC;oBAC1D,OAAO,KAAK,CAAC;gBACf,CAAC;gBACD,IAAI,CAAC,KAAK,CAAC,aAAa,CAAC,KAAK,CAAC,EAAE,CAAC;oBAChC,OAAO,CAAC,KAAK,CAAC,iCAAiC,EAAE,EAAE,KAAK,EAAE,GAAG,EAAE,KAAK,EAAE,CAAC,CAAC;oBACxE,OAAO,KAAK,CAAC;gBACf,CAAC;gBACD,OAAO,IAAI,CAAC;YACd,CAAC,CAAC;YAEF,IAAI,GAAG,KAAK,cAAc,EAAE,CAAC;gBAC3B,IAAI,CAAC,kBAAkB,EAAE;oBAAE,SAAS;gBACpC,GAAG,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,cAAc,EAAE,KAAK,EAAE,YAAY,EAAE,KAAK,EAAE,QAAQ,EAAE,CAAC,CAAC;gBACzE,OAAO,CAAC,KAAK,CAAC,8BAA8B,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,CAAC,CAAC;gBAChE,SAAS;YACX,CAAC;YAED,IAAI,GAAG,KAAK,kBAAkB,EAAE,CAAC;gBAC/B,IAAI,CAAC,kBAAkB,EAAE;oBAAE,SAAS;gBACpC,MAAM,GAAG,GAAG,MAAM,CAAC,CAAC,CAAC,UAAU,IAAI,CAAC,CAAC,CAAC;gBACtC,GAAG,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,gBAAgB,EAAE,KAAK,EAAE,UAAU,EAAE,GAAG,EAAE,YAAY,EAAE,KAAK,EAAE,QAAQ,EAAE,CAAC,CAAC;gBAC5F,OAAO,CAAC,KAAK,CAAC,gCAAgC,EAAE,EAAE,KAAK,EAAE,UAAU,EAAE,GAAG,EAAE,KAAK,EAAE,CAAC,CAAC;gBACnF,SAAS;YACX,CAAC;YAED,IAAI,GAAG,KAAK,kBAAkB,EAAE,CAAC;gBAC/B,IAAI,CAAC,kBAAkB,EAAE;oBAAE,SAAS;gBACpC,GAAG,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,kBAAkB,EAAE,KAAK,EAAE,YAAY,EAAE,KAAK,EAAE,QAAQ,EAAE,CAAC,CAAC;gBAC7E,OAAO,CAAC,KAAK,CAAC,kCAAkC,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,CAAC,CAAC;gBACpE,SAAS;YACX,CAAC;YAED,IAAI,GAAG,KAAK,sBAAsB,EAAE,CAAC;gBACnC,GAAG,CAAC,IAAI,CAAC;oBACP,IAAI,EAAE,qBAAqB;oBAC3B,KAAK;oBACL,YAAY;oBACZ,KAAK;oBACL,QAAQ;oBACR,iBAAiB,EAAE,CAAC,CAAC,QAAQ;oBAC7B,UAAU,EAAE,CAAC,CAAC,UAAU;oBACxB,UAAU,EAAE,MAAM,CAAC,CAAC,CAAC,UAAU,IAAI,CAAC,CAAC;oBACrC,cAAc,EAAE,MAAM,CAAC,CAAC,CAAC,cAAc,IAAI,CAAC,CAAC;iBAC9C,CAAC,CAAC;gBACH,OAAO,CAAC,KAAK,CAAC,sCAAsC,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,CAAC,CAAC;gBACxE,SAAS;YACX,CAAC;YAED,IAAI,GAAG,KAAK,mBAAmB,EAAE,CAAC;gBAChC,GAAG,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,kBAAkB,EAAE,KAAK,EAAE,YAAY,EAAE,KAAK,EAAE,QAAQ,EAAE,CAAC,CAAC;gBAC7E,OAAO,CAAC,KAAK,CAAC,mCAAmC,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,CAAC,CAAC;gBACrE,SAAS;YACX,CAAC;YAED,IAAI,GAAG,KAAK,uBAAuB,EAAE,CAAC;gBACpC,GAAG,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,qBAAqB,EAAE,KAAK,EAAE,YAAY,EAAE,KAAK,EAAE,QAAQ,EAAE,CAAC,CAAC;gBAChF,OAAO,CAAC,KAAK,CAAC,uCAAuC,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE,CAAC,CAAC;gBACzE,SAAS;YACX,CAAC;YAED,+DAA+D;YAC/D,OAAO,CAAC,KAAK,CAAC,6BAA6B,EAAE,EAAE,GAAG,EAAE,KAAK,EAAE,YAAY,EAAE,QAAQ,EAAE,IAAI,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,SAAS,EAAE,CAAC,CAAC;QACjI,CAAC;QAED,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,CAAC,YAAY,GAAG,CAAC,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC,CAAC,QAAQ,GAAG,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC;QACnF,OAAO,CAAC,KAAK,CAAC,iBAAiB,EAAE,EAAE,UAAU,EAAE,OAAO,EAAE,MAAM,CAAC,MAAM,EAAE,IAAI,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,CAAC;QAC3F,OAAO,GAAG,CAAC;IACb,CAAC;CACF;AArHD,kEAqHC","sourcesContent":["// src/delegates/ContractCallEventNormalizer.ts\nimport type { IStacksChainClient } from '../contracts/interfaces';\nimport type { ISqliteStore } from '../contracts/dao';\nimport type { NormalizedEvent } from '../contracts/domain';\nimport { hexToCV, cvToJSON } from '@stacks/transactions';\n\n// ─── helpers ─────────────────────────────────────────────────────────────────\nconst cleanHex64 = (x?: string) => String(x ?? '').replace(/^0x/i, '').toLowerCase();\nconst toNumU = (nLike: any) => {\n  const s = String(nLike ?? '');\n  return Number(s.startsWith('u') ? s.slice(1) : s);\n};\nconst isContractLog = (ev: any) => {\n  const t = ev?.event_type || ev?.eventType;\n  return t === 'smart_contract_log' || t === 'contract_log';\n};\nconst short = (s: string, n = 120) => s.length > n ? `${s.slice(0, n)}…` : s;\n\n// Parse a contract_log `{ value: {hex, repr} }` into { tag, idHex, amountSats, ... }\nfunction parsePrint(ev: any) {\n  const v = ev?.contract_log?.value;\n  const repr: string = String(v?.repr ?? '');\n  const hex: string | undefined = v?.hex;\n\n  if (hex) {\n    try {\n      const cv = hexToCV(hex);\n      let j: any = cvToJSON(cv);\n      if (j?.type === 'response' && j.value) j = j.value;\n\n      // Normalize to the inner tuple\n      let tuple = j;\n      if (tuple?.type !== 'tuple' && tuple?.value?.type === 'tuple') tuple = tuple.value;\n\n      // Tuples from cvToJSON can be arrays of { name, value, type }\n      const fields: any[] = Array.isArray(tuple?.value) ? tuple.value : [];\n      const get = (k: string) => fields.find((x: any) => x?.name === k)?.value;\n\n      // Tag/event\n      const tagVal = get('event') ?? get('tag');\n      const tag = String(tagVal?.value ?? tagVal ?? '').toLowerCase();\n\n      // ID (buff)\n      const idCV = get('id');\n      const idHex = cleanHex64(String(idCV?.value ?? idCV ?? ''));\n\n      // Amount (uint)\n      const amtCV = get('amount');\n      const amountSats = toNumU(amtCV?.value ?? amtCV);\n\n      // Optionals\n      const merchantVal = get('merchant');\n      const merchant = String(merchantVal?.value ?? merchantVal ?? '') || undefined;\n\n      const subscriberVal = get('subscriber');\n      const subscriber = String(subscriberVal?.value ?? subscriberVal ?? '') || undefined;\n\n      const intervalVal = get('interval-blocks') ?? get('interval');\n      const intervalBlocks = toNumU(intervalVal?.value ?? intervalVal);\n\n      if (tag) {\n        return { tag, idHex, amountSats, merchant, subscriber, intervalBlocks, repr };\n      }\n    } catch {\n      // fall through to repr parsing\n    }\n  }\n\n  // Fallback: “…invoice-refunded… 0x<64> … u<amt> …”\n  const m =\n    /(invoice-(?:paid|refunded|canceled))(?:(?!\\n).)*(0x[0-9a-fA-F]{64})?(?:(?!\\n).)*u(\\d+)/.exec(\n      repr\n    );\n  if (m) {\n    return {\n      tag: m[1].toLowerCase(),\n      idHex: cleanHex64(m[2] || ''),\n      amountSats: Number(m[3] || '0'),\n      repr,\n    };\n  }\n\n  const sm = /(subscription-(?:created|paid|canceled))/.exec(repr);\n  if (sm) return { tag: sm[1].toLowerCase(), repr };\n\n  return null;\n}\n\n// ─── main ────────────────────────────────────────────────────────────────────\nexport class ContractCallEventNormalizer {\n  async fetchAndFilterEvents(fromHeight: number, chain: IStacksChainClient, store: ISqliteStore) {\n    const events = await chain.getContractCallEvents({ fromHeight });\n\n    const out: NormalizedEvent[] = [];\n\n    for (const ev of events) {\n      // gate 1: only contract logs\n      if (!isContractLog(ev)) {\n        console.debug('[EVT:NORM] skip:non-contract-log', {\n          tx_id: ev?.tx_id ?? ev?.txid,\n          event_type: ev?.event_type || ev?.eventType,\n        });\n        continue;\n      }\n\n      // gate 2: block height must be present\n      const block_height = Number(ev?.block_height ?? ev?.tx?.block_height ?? NaN);\n      if (!Number.isFinite(block_height)) {\n        console.debug('[EVT:NORM] skip:no-block-height', {\n          tx_id: ev?.tx_id ?? ev?.txid,\n        });\n        continue;\n      }\n\n      const tx_id: string = String(ev?.tx_id ?? ev?.txid ?? '');\n      const tx_index: number = Number(ev?.tx_index ?? 0);\n\n      // parse the printed payload\n      const p = parsePrint(ev);\n      if (!p) {\n        const repr = String(ev?.contract_log?.value?.repr ?? '');\n        console.debug('[EVT:NORM] skip:parse-null', {\n          tx_id, block_height, tx_index, repr: short(repr),\n        });\n        continue;\n      }\n\n      console.debug('[EVT:NORM] parsed', {\n        tag: p.tag, idHex: p.idHex, amountSats: p.amountSats, tx_id, block_height, tx_index,\n        repr: p.repr ? short(p.repr) : undefined,\n      });\n\n      // Map → NormalizedEvent\n      const tag = p.tag;\n      const idHex = cleanHex64(p.idHex);\n\n      const ensureKnownInvoice = () => {\n        if (!idHex) {\n          console.debug('[EVT:NORM] drop:empty-id', { tx_id, tag });\n          return false;\n        }\n        if (!store.invoiceExists(idHex)) {\n          console.debug('[EVT:NORM] drop:unknown-invoice', { tx_id, tag, idHex });\n          return false;\n        }\n        return true;\n      };\n\n      if (tag === 'invoice-paid') {\n        if (!ensureKnownInvoice()) continue;\n        out.push({ type: 'invoice-paid', idHex, block_height, tx_id, tx_index });\n        console.debug('[EVT:NORM] push:invoice-paid', { idHex, tx_id });\n        continue;\n      }\n\n      if (tag === 'invoice-refunded') {\n        if (!ensureKnownInvoice()) continue;\n        const amt = Number(p.amountSats ?? 0);\n        out.push({ type: 'refund-invoice', idHex, amountSats: amt, block_height, tx_id, tx_index });\n        console.debug('[EVT:NORM] push:refund-invoice', { idHex, amountSats: amt, tx_id });\n        continue;\n      }\n\n      if (tag === 'invoice-canceled') {\n        if (!ensureKnownInvoice()) continue;\n        out.push({ type: 'invoice-canceled', idHex, block_height, tx_id, tx_index });\n        console.debug('[EVT:NORM] push:invoice-canceled', { idHex, tx_id });\n        continue;\n      }\n\n      if (tag === 'subscription-created') {\n        out.push({\n          type: 'create-subscription',\n          idHex,\n          block_height,\n          tx_id,\n          tx_index,\n          merchantPrincipal: p.merchant,\n          subscriber: p.subscriber,\n          amountSats: Number(p.amountSats ?? 0),\n          intervalBlocks: Number(p.intervalBlocks ?? 0),\n        });\n        console.debug('[EVT:NORM] push:subscription-created', { idHex, tx_id });\n        continue;\n      }\n\n      if (tag === 'subscription-paid') {\n        out.push({ type: 'pay-subscription', idHex, block_height, tx_id, tx_index });\n        console.debug('[EVT:NORM] push:subscription-paid', { idHex, tx_id });\n        continue;\n      }\n\n      if (tag === 'subscription-canceled') {\n        out.push({ type: 'cancel-subscription', idHex, block_height, tx_id, tx_index });\n        console.debug('[EVT:NORM] push:subscription-canceled', { idHex, tx_id });\n        continue;\n      }\n\n      // Unknown tag — show a crumb so you notice typos/schema drifts\n      console.debug('[EVT:NORM] skip:unknown-tag', { tag, tx_id, block_height, tx_index, repr: p.repr ? short(p.repr) : undefined });\n    }\n\n    out.sort((a, b) => (a.block_height - b.block_height) || (a.tx_index - b.tx_index));\n    console.debug('[EVT:NORM] done', { fromHeight, fetched: events.length, kept: out.length });\n    return out;\n  }\n}\n"]}